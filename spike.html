<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Phase 0 Spike — RJSF + React 19 + htm CDN</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #F7F8FA;
      --panel: #ffffff;
      --border: #E2E6EA;
      --text: #16222e;
      --muted: #536477;
      --accent: #037CC2;
      --accent-light: rgba(3,124,194,0.10);
      --radius: 10px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Poppins", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    #loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      gap: 12px;
      color: var(--muted);
      font-size: 14px;
    }
    #loading .spinner {
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loading.error { color: #A32E2E; }

    /* Form styles */
    .spike-layout {
      max-width: 720px;
      margin: 24px auto;
      padding: 0 16px;
    }
    .spike-header {
      margin-bottom: 20px;
    }
    .spike-header h1 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .spike-header p {
      font-size: 13px;
      color: var(--muted);
    }
    .spike-status {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 12px 0 20px;
    }
    .spike-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    .spike-badge.ok { background: #E8F5E9; color: #2E7D32; }
    .spike-badge.fail { background: #FFEBEE; color: #C62828; }
    .spike-badge.pending { background: #FFF3E0; color: #E65100; }

    /* RJSF overrides */
    .form-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }
    .form-panel fieldset {
      border: none;
      padding: 0;
      margin: 0;
    }
    .form-panel legend {
      display: none;
    }
    .form-panel .field-group {
      margin-bottom: 4px;
    }
    .form-panel .field-group summary {
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      padding: 10px 0;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      user-select: none;
    }
    .form-panel .field-group summary::before {
      content: "\25B6";
      font-size: 8px;
      transition: transform 0.15s ease;
      display: inline-block;
    }
    .form-panel .field-group[open] summary::before {
      transform: rotate(90deg);
    }
    .form-panel .field-group summary .badge {
      background: var(--accent-light);
      color: var(--accent);
      font-size: 10px;
      padding: 1px 7px;
      border-radius: 10px;
      font-weight: 600;
    }
    .form-panel .field-group .group-fields {
      padding: 12px 0 8px 0;
    }
    .form-panel .form-group {
      margin-bottom: 14px;
    }
    .form-panel label.control-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px;
    }
    .form-panel .field-description {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
      line-height: 1.4;
    }
    .form-panel input[type="text"],
    .form-panel input[type="number"],
    .form-panel select,
    .form-panel textarea {
      width: 100%;
      padding: 8px 10px;
      font-size: 13px;
      font-family: inherit;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: inherit;
      background: #fff;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .form-panel input:focus,
    .form-panel select:focus,
    .form-panel textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(3,124,194,0.12);
    }
    .form-panel .checkbox label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
    }
    .form-panel .checkbox input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
    }
    .form-panel .btn-group,
    .form-panel .rjsf > .form-group > p,
    .form-panel [type="submit"] {
      display: none;
    }
    .form-data-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-top: 16px;
    }
    .form-data-panel h3 {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .form-data-panel pre {
      font-size: 11px;
      line-height: 1.5;
      background: var(--bg);
      border-radius: 6px;
      padding: 12px;
      overflow-x: auto;
      max-height: 300px;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <div>Loading React + RJSF from CDN…</div>
  </div>
  <div id="root" style="display:none"></div>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@19.0.0",
      "react/jsx-runtime": "https://esm.sh/react@19.0.0/jsx-runtime",
      "react-dom": "https://esm.sh/react-dom@19.0.0",
      "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
      "htm": "https://esm.sh/htm@3.1.1",
      "@rjsf/core": "https://esm.sh/@rjsf/core@5.22.4?external=react,react-dom",
      "@rjsf/utils": "https://esm.sh/@rjsf/utils@5.22.4?external=react,react-dom",
      "@rjsf/validator-ajv8": "https://esm.sh/@rjsf/validator-ajv8@5.22.4?external=react,react-dom"
    }
  }
  </script>

  <!-- CDN timeout fallback (non-module script runs immediately) -->
  <script>
    window.__spikeReady = false;
    setTimeout(function() {
      if (!window.__spikeReady) {
        var el = document.getElementById("loading");
        el.innerHTML = "<div style='text-align:center;padding:20px'>" +
          "<h2 style='color:#A32E2E;margin-bottom:8px'>CDN Loading Failed</h2>" +
          "<p style='color:#536477;font-size:13px'>Could not load dependencies from esm.sh.<br>" +
          "Check your internet connection and try again.</p>" +
          "<p style='color:#536477;font-size:12px;margin-top:12px'>Open DevTools console for details.</p></div>";
        el.classList.add("error");
      }
    }, 15000);
  </script>

  <script type="module">
    // ── 1. Import CDN dependencies ──────────────────────────────
    import React, { useState, useCallback, createElement } from "react";
    import { createRoot } from "react-dom/client";
    import htm from "htm";
    import Form from "@rjsf/core";
    import validator from "@rjsf/validator-ajv8";
    import { getDefaultFormState } from "@rjsf/utils";

    const html = htm.bind(createElement);

    // ── 2. BarChartConfig schema (from tpsplots) ────────────────
    const RAW_SCHEMA = {
      "additionalProperties": false,
      "title": "BarChartConfig",
      "type": "object",
      "required": ["output", "title"],
      "properties": {
        "output": {"type": "string", "title": "Output", "description": "Base filename for chart outputs"},
        "title": {"type": "string", "title": "Title", "description": "Chart title"},
        "subtitle": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Subtitle", "description": "Chart subtitle (supports {{variable}} templates)"},
        "source": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Source", "description": "Data source attribution"},
        "type": {"const": "bar", "default": "bar", "type": "string", "title": "Type", "description": "Chart type discriminator"},
        "figsize": {"anyOf": [{"items": {"type": "number"}, "type": "array"}, {"type": "null"}], "default": null, "title": "Figsize", "description": "Figure size as [width, height] in inches"},
        "dpi": {"anyOf": [{"type": "integer"}, {"type": "null"}], "default": null, "title": "DPI", "description": "Dots per inch for output resolution"},
        "export_data": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Export Data", "description": "Data reference for CSV export"},
        "matplotlib_config": {"anyOf": [{"additionalProperties": true, "type": "object"}, {"type": "null"}], "default": null, "title": "Matplotlib Config", "description": "Raw matplotlib kwargs merged into the plot call"},
        "sort_by": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Sort By", "description": "Sort criterion: 'value' or 'category'"},
        "sort_ascending": {"anyOf": [{"type": "boolean"}, {"type": "null"}], "default": null, "title": "Sort Ascending", "description": "Sort direction (False = descending)"},
        "width": {"anyOf": [{"type": "number"}, {"type": "null"}], "default": null, "title": "Width", "description": "Bar width (0.0-1.0). Default: 0.8"},
        "height": {"anyOf": [{"type": "number"}, {"type": "null"}], "default": null, "title": "Height", "description": "Bar height (0.0-1.0). Default: 0.8"},
        "alpha": {"anyOf": [{"type": "number"}, {"type": "null"}], "default": null, "title": "Alpha", "description": "Bar transparency (0.0-1.0). Default: 1.0"},
        "edgecolor": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Edge Color", "description": "Bar border color. Default: 'white'"},
        "linewidth": {"anyOf": [{"type": "number"}, {"type": "null"}], "default": null, "title": "Line Width", "description": "Bar border width in points. Default: 0.5"},
        "orientation": {"anyOf": [{"enum": ["vertical", "horizontal"], "type": "string"}, {"type": "null"}], "default": null, "title": "Orientation", "description": "Bar orientation: 'vertical' or 'horizontal'"},
        "show_category_ticks": {"anyOf": [{"type": "boolean"}, {"type": "null"}], "default": null, "title": "Show Category Ticks", "description": "Show tick marks on category axis"},
        "baseline": {"anyOf": [{"type": "number"}, {"type": "null"}], "default": null, "title": "Baseline", "description": "Reference value for bar positioning. Default: 0"},
        "show_values": {"anyOf": [{"type": "boolean"}, {"type": "null"}], "default": null, "title": "Show Values", "description": "Display value labels on each bar"},
        "value_format": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Value Format", "description": "Format for value labels: preset name or format spec"},
        "value_suffix": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Value Suffix", "description": "Text appended after each value label"},
        "value_offset": {"anyOf": [{"type": "number"}, {"type": "null"}], "default": null, "title": "Value Offset", "description": "Distance from bar end to value label"},
        "value_fontsize": {"anyOf": [{"type": "number"}, {"type": "string"}, {"type": "null"}], "default": null, "title": "Value Font Size", "description": "Font size for value labels"},
        "value_color": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Value Color", "description": "Text color for value labels"},
        "value_weight": {"anyOf": [{"enum": ["normal", "bold"], "type": "string"}, {"type": "string"}, {"type": "null"}], "default": null, "title": "Value Weight", "description": "Font weight for value labels"},
        "scale": {"anyOf": [{"enum": ["billions", "millions", "thousands", "percentage"], "type": "string"}, {"type": "string"}, {"type": "null"}], "default": null, "title": "Scale", "description": "Scale formatting for values"},
        "axis_scale": {"anyOf": [{"enum": ["x", "y", "both"], "type": "string"}, {"type": "null"}], "default": null, "title": "Axis Scale", "description": "Which axis to apply scale to: 'x', 'y', or 'both'"},
        "x_tick_format": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "X Tick Format", "description": "Format spec for x-axis tick labels"},
        "y_tick_format": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Y Tick Format", "description": "Format spec for y-axis tick labels"},
        "fiscal_year_ticks": {"anyOf": [{"type": "boolean"}, {"type": "null"}], "default": null, "title": "Fiscal Year Ticks", "description": "Format x-axis ticks as fiscal years"},
        "max_xticks": {"anyOf": [{"type": "integer"}, {"type": "string"}, {"type": "null"}], "default": null, "title": "Max X Ticks", "description": "Maximum number of x-axis ticks"},
        "legend": {"anyOf": [{"type": "boolean"}, {"additionalProperties": true, "type": "object"}, {"type": "string"}, {"type": "null"}], "default": null, "title": "Legend", "description": "Legend display configuration"},
        "grid": {"anyOf": [{"type": "boolean"}, {"additionalProperties": true, "type": "object"}, {"type": "string"}, {"type": "null"}], "default": null, "title": "Grid", "description": "Grid display configuration"},
        "grid_axis": {"anyOf": [{"enum": ["x", "y", "both"], "type": "string"}, {"type": "null"}], "default": null, "title": "Grid Axis", "description": "Which axis to show grid lines on"},
        "xlim": {"anyOf": [{"items": {}, "type": "array"}, {"additionalProperties": true, "type": "object"}, {"type": "string"}, {"type": "null"}], "default": null, "title": "X Limits", "description": "X-axis limits"},
        "ylim": {"anyOf": [{"items": {}, "type": "array"}, {"additionalProperties": true, "type": "object"}, {"type": "string"}, {"type": "null"}], "default": null, "title": "Y Limits", "description": "Y-axis limits"},
        "xlabel": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "X Label", "description": "X-axis label text"},
        "ylabel": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Y Label", "description": "Y-axis label text"},
        "tick_rotation": {"anyOf": [{"type": "number"}, {"type": "null"}], "default": null, "title": "Tick Rotation", "description": "Rotation angle for x-axis tick labels"},
        "tick_size": {"anyOf": [{"type": "number"}, {"type": "string"}, {"type": "null"}], "default": null, "title": "Tick Size", "description": "Font size for axis tick labels"},
        "label_size": {"anyOf": [{"type": "number"}, {"type": "string"}, {"type": "null"}], "default": null, "title": "Label Size", "description": "Font size for axis labels"},
        "categories": {"default": null, "title": "Categories", "description": "Category labels for the axis"},
        "values": {"default": null, "title": "Values", "description": "Bar values"},
        "colors": {"anyOf": [{"type": "string"}, {"items": {"type": "string"}, "type": "array"}, {"type": "null"}], "default": null, "title": "Colors", "description": "Bar color(s)"},
        "positive_color": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Positive Color", "description": "Color for positive values"},
        "negative_color": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Negative Color", "description": "Color for negative values"},
        "x_axis_format": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "X Axis Format", "description": "Legacy alias for x_tick_format"},
        "y_axis_format": {"anyOf": [{"type": "string"}, {"type": "null"}], "default": null, "title": "Y Axis Format", "description": "Legacy alias for y_tick_format"}
      }
    };

    // ── 3. anyOf cleanup (strips null branch) ───────────────────
    // Pydantic generates anyOf: [{type: X}, {type: null}] for Optional[X].
    // RJSF renders these as a confusing "Option 1 / Option 2" dropdown.
    // Solution: strip the null branch so RJSF sees a plain type.
    function simplifyAnyOf(schema) {
      const cleaned = { ...schema };
      if (cleaned.properties) {
        cleaned.properties = { ...cleaned.properties };
        for (const [key, prop] of Object.entries(cleaned.properties)) {
          if (prop.anyOf) {
            const nonNull = prop.anyOf.filter(s => s.type !== "null");
            if (nonNull.length === 1) {
              // Simple case: anyOf: [{type: X}, {type: null}] → just {type: X}
              const { anyOf, ...rest } = prop;
              cleaned.properties[key] = { ...rest, ...nonNull[0] };
            } else if (nonNull.length > 1) {
              // Complex: multiple non-null types (e.g., legend: bool|object|string)
              // Keep anyOf but remove null branch — RJSF handles multi-type anyOf
              const { anyOf, ...rest } = prop;
              cleaned.properties[key] = { ...rest, anyOf: nonNull };
            }
          }
        }
      }
      return cleaned;
    }

    // ── 4. Field grouping (mirrors mixin structure) ─────────────
    const FIELD_GROUPS = [
      { name: "Identity", fields: ["type", "output", "title", "subtitle", "source"], defaultOpen: true },
      { name: "Data Bindings", fields: ["categories", "values", "colors", "positive_color", "negative_color"] },
      { name: "Bar Styling", fields: ["width", "height", "alpha", "edgecolor", "linewidth", "orientation", "show_category_ticks", "baseline"] },
      { name: "Value Labels", fields: ["show_values", "value_format", "value_suffix", "value_offset", "value_fontsize", "value_color", "value_weight"] },
      { name: "Sort", fields: ["sort_by", "sort_ascending"] },
      { name: "Scale", fields: ["scale", "axis_scale"] },
      { name: "Tick Format", fields: ["x_tick_format", "y_tick_format", "fiscal_year_ticks", "max_xticks"] },
      { name: "Legend", fields: ["legend"] },
      { name: "Grid", fields: ["grid", "grid_axis"] },
      { name: "Axis", fields: ["xlim", "ylim", "xlabel", "ylabel", "tick_rotation", "tick_size", "label_size"] },
      { name: "Figure", fields: ["figsize", "dpi", "export_data", "matplotlib_config"] },
      { name: "Legacy", fields: ["x_axis_format", "y_axis_format"] },
    ];

    // Build reverse map: field → group
    const fieldToGroup = {};
    for (const group of FIELD_GROUPS) {
      for (const field of group.fields) {
        fieldToGroup[field] = group.name;
      }
    }

    // ── 5. uiSchema ────────────────────────────────────────────
    const uiSchema = {
      "ui:order": FIELD_GROUPS.flatMap(g => g.fields),
      // Hide type (constant), hide data bindings (Phase 1)
      type: { "ui:widget": "hidden" },
      categories: { "ui:widget": "hidden" },
      values: { "ui:widget": "hidden" },
      // Legacy fields hidden
      x_axis_format: { "ui:widget": "hidden" },
      y_axis_format: { "ui:widget": "hidden" },
    };

    // ── 6. Custom ObjectFieldTemplate ──────────────────────────
    function GroupedObjectFieldTemplate(props) {
      const { properties, title, description } = props;

      // Build a lookup: fieldName → rendered element
      const fieldMap = {};
      for (const prop of properties) {
        fieldMap[prop.name] = prop.content;
      }

      // Collect hidden fields (rendered but not grouped visually)
      const hiddenFields = new Set(["type", "categories", "values", "x_axis_format", "y_axis_format"]);

      return html`
        <div>
          ${FIELD_GROUPS.map(group => {
            const visibleFields = group.fields.filter(f => !hiddenFields.has(f) && fieldMap[f]);
            if (visibleFields.length === 0) return null;

            return html`
              <details key=${group.name} class="field-group" open=${group.defaultOpen || false}>
                <summary>
                  ${group.name}
                  <span class="badge">${visibleFields.length}</span>
                </summary>
                <div class="group-fields">
                  ${visibleFields.map(f => html`<div key=${f}>${fieldMap[f]}</div>`)}
                </div>
              </details>
            `;
          })}
          ${/* Hidden fields still rendered for form data */
            [...hiddenFields].map(f => fieldMap[f]
              ? html`<div key=${f} style=${{ display: "none" }}>${fieldMap[f]}</div>`
              : null
            )}
        </div>
      `;
    }

    // ── 7. Spike App ───────────────────────────────────────────
    function SpikeApp() {
      const [formData, setFormData] = useState({ type: "bar", output: "my_chart", title: "Sample Bar Chart" });
      const [checks, setChecks] = useState({
        react: "ok",
        rjsf: "pending",
        htm: "ok",
        template: "pending",
        anyOf: "pending",
      });

      const schema = simplifyAnyOf(RAW_SCHEMA);

      const handleChange = useCallback((e) => {
        setFormData(e.formData);
        // Mark checks as passing once form renders and changes
        setChecks(prev => ({
          ...prev,
          rjsf: "ok",
          template: "ok",
          anyOf: "ok",
        }));
      }, []);

      return html`
        <div class="spike-layout">
          <div class="spike-header">
            <h1>Phase 0: CDN Integration Spike</h1>
            <p>Validates React 19 + RJSF v5 + htm from esm.sh with custom ObjectFieldTemplate</p>
          </div>

          <div class="spike-status">
            ${Object.entries(checks).map(([name, status]) =>
              html`<span key=${name} class="spike-badge ${status}">
                ${status === "ok" ? "\u2713" : status === "fail" ? "\u2717" : "\u2026"} ${name}
              </span>`
            )}
          </div>

          <div class="form-panel">
            <${Form}
              schema=${schema}
              uiSchema=${uiSchema}
              formData=${formData}
              validator=${validator}
              onChange=${handleChange}
              templates=${{ ObjectFieldTemplate: GroupedObjectFieldTemplate }}
              liveValidate=${false}
              showErrorList=${false}
            >
              <${React.Fragment} />
            <//>
          </div>

          <div class="form-data-panel">
            <h3>Form Data (live)</h3>
            <pre>${JSON.stringify(formData, null, 2)}</pre>
          </div>
        </div>
      `;
    }

    // ── 8. Mount ───────────────────────────────────────────────
    window.__spikeReady = true;
    document.getElementById("loading").style.display = "none";
    document.getElementById("root").style.display = "block";

    const root = createRoot(document.getElementById("root"));
    root.render(html`<${SpikeApp} />`);

    console.log("[spike] React version:", React.version);
    console.log("[spike] All CDN modules loaded successfully");
  </script>
</body>
</html>
