name: Upload Charts to S3

on:
  # Allow manual triggering with artifact selection
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID containing the charts to upload (leave empty to use latest)'
        required: false
        type: string
      dry_run:
        description: 'Run in dry-run mode (preview upload without actually uploading)'
        required: false
        default: false
        type: boolean
  
  # Schedule to run 1 day after chart generation (every 3 months + 1 day)
  schedule:
    - cron: '0 2 2 */3 *'  # 2nd day of every 3rd month at 2 AM UTC

env:
  # AWS configuration
  AWS_DEFAULT_REGION: us-east-1
  # S3 bucket configuration
  S3_BUCKET: planetary
  S3_PREFIX: assets/charts/

jobs:
  upload-to-s3:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install boto3
        
    - name: Find latest chart generation run
      id: find-run
      run: |
        if [ -n "${{ inputs.run_id }}" ]; then
          echo "Using specified run ID: ${{ inputs.run_id }}"
          echo "run_id=${{ inputs.run_id }}" >> $GITHUB_OUTPUT
        else
          echo "Finding latest chart generation run..."
          # Get the latest successful run of the chart generation workflow
          latest_run=$(gh run list \
            --workflow="generate-and-sync-charts.yml" \
            --status=success \
            --limit=1 \
            --json=databaseId \
            --jq='.[0].databaseId')
          
          if [ -z "$latest_run" ]; then
            echo "No successful chart generation runs found"
            exit 1
          fi
          
          echo "Found latest run: $latest_run"
          echo "run_id=$latest_run" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ github.token }}
        
    - name: Download chart artifacts
      uses: actions/download-artifact@v4
      with:
        name: generated-charts
        path: charts/
        run-id: ${{ steps.find-run.outputs.run_id }}
        
    - name: Verify charts downloaded
      run: |
        echo "Downloaded charts:"
        find charts -type f -name "*.png" -o -name "*.svg" -o -name "*.pptx" -o -name "*.csv" | head -10
        
        total_files=$(find charts -type f -name "*.png" -o -name "*.svg" -o -name "*.pptx" -o -name "*.csv" | wc -l)
        echo "Total chart files: $total_files"
        
        if [ "$total_files" -eq 0 ]; then
          echo "Error: No chart files found in artifacts"
          exit 1
        fi
        
        echo "Charts ready for upload!"
        
    - name: Configure AWS credentials
      if: ${{ !inputs.dry_run }}
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_DEFAULT_REGION }}
        
    - name: Upload charts to S3 (dry run)
      if: ${{ inputs.dry_run }}
      run: |
        echo "DRY RUN: Uploading charts to S3..."
        python scripts/s3_sync.py \
          --local-dir charts \
          --bucket ${{ env.S3_BUCKET }} \
          --prefix ${{ env.S3_PREFIX }} \
          --dry-run
          
    - name: Upload charts to S3
      if: ${{ !inputs.dry_run }}
      run: |
        echo "Uploading charts to S3..."
        python scripts/s3_sync.py \
          --local-dir charts \
          --bucket ${{ env.S3_BUCKET }} \
          --prefix ${{ env.S3_PREFIX }}
          
    - name: Create deployment summary
      run: |
        echo "## S3 Upload Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Source" >> $GITHUB_STEP_SUMMARY
        echo "- **Run ID**: ${{ steps.find-run.outputs.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Artifact**: generated-charts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Upload Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Total files**: $(find charts -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- **PNG files**: $(find charts -name "*.png" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- **SVG files**: $(find charts -name "*.svg" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- **PPTX files**: $(find charts -name "*.pptx" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- **CSV files**: $(find charts -name "*.csv" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- **Total size**: $(du -sh charts | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ inputs.dry_run }}" = "true" ]; then
          echo "### Status: DRY RUN" >> $GITHUB_STEP_SUMMARY
          echo "Charts were downloaded but not uploaded to S3." >> $GITHUB_STEP_SUMMARY
        else
          echo "### Status: COMPLETED" >> $GITHUB_STEP_SUMMARY
          echo "Charts uploaded to s3://${{ env.S3_BUCKET }}/${{ env.S3_PREFIX }}" >> $GITHUB_STEP_SUMMARY
        fi